<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Server Tags</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #1e1e2f;
            color: #fff;
            margin: 0;
            padding: 0;
        }

        center {
            margin-top: 15px;
        }

        header {
            text-align: center;
            padding: 20px;
            background-color: #2a2a3b;
        }

        header h1 {
            font-size: 2.5em;
        }

        .intro {
            margin-top: 10px;
            font-size: 1.2em;
            color: #ccc;
        }

        .publish-button,
        .support-button {
            background-color: #ffcc00;
            color: #000;
            padding: 12px 24px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 8px;
            text-decoration: none;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        table {
            width: 90%;
            margin: 0 auto 40px auto;
            border-collapse: collapse;
            background-color: #2a2a3b;
            border: 1px solid #444;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #444;
        }

        th {
            background-color: #3a3a4d;
        }

        tr:hover {
            background-color: #333348;
        }

        a {
            color: #00b7ff;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .new {
            color: red;
            font-weight: bold;
            margin-left: 8px;
            font-size: 0.8em;
            padding: 2px 5px;
            background-color: rgba(255, 77, 77, 0.2);
            border-radius: 4px;
        }


        /* submit form */
        .submit-section {
            background-color: #2b2d31;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 75%;
        }

        .submit-section h2 {
            color: #5865f2;
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .submit-section p {
            color: #dcddde;
            margin-bottom: 20px;
        }

        #tag-submit-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-group label {
            color: #dcddde;
            font-weight: 600;
        }

        .input-group input {
            background-color: #36393f;
            border: 1px solid #202225;
            border-radius: 4px;
            padding: 12px 16px;
            color: white;
            font-size: 1em;
            transition: border-color 0.2s ease;
        }

        .input-group input:focus {
            border-color: #5865f2;
            outline: none;
            box-shadow: 0 0 0 2px rgba(88, 101, 242, 0.3);
        }

        .submit-button {
            background-color: #5865f2;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 12px 20px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-top: 10px;
        }

        .submit-button:hover {
            background-color: #4752c4;
        }

        .submit-button:disabled {
            background-color: #3c3f5c;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .submission-status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
            display: none;
        }

        .submission-status.loading {
            display: block;
            background-color: #36393f;
            color: #dcddde;
        }

        .submission-status.success {
            display: block;
            background-color: #43b581;
            color: white;
        }

        .submission-status.error {
            display: block;
            background-color: #f04747;
            color: white;
        }

        #search-box {
            display: block;
            margin: 20px auto;
            width: 60%;
            padding: 10px;
            font-size: 16px;
            border-radius: 6px;
            border: 1px solid #444;
            background-color: #2b2d31;
            color: white;
        }

        @media (max-width: 768px) {
            .submit-section {
                padding: 15px;
                margin: 15px 0;
            }

            .submit-section h2 {
                font-size: 1.5em;
            }

            .input-group input,
            .submit-button {
                padding: 10px 14px;
            }
        }

        .icon {
            margin-right: 5px;
            height: 16px;
            width: 16px;
        }

        #blacklist {
            display: none;
        }
    </style>
</head>

<body>

    <header>
        <h1>Discord Server Tags</h1>
        <p class="intro">Join over ⚡2,000,000 users currently exploring!</p>
    </header>

    <center>
        <a href="https://discord.gg/bpW5jyQ2" target="_blank" class="support-button">🚀 Join the support server</a>

        <div class="submit-section">
            <h2>Submit a Server Tag</h2>
            <p>Have a server with a tag that's not listed? Submit it below!</p>

            <form id="tag-submit-form">
                <div class="input-group">
                    <label for="server-invite">Discord Server Invite</label>
                    <input type="text" id="server-invite" placeholder="discord.gg/invite-code or just the invite code"
                        required>
                </div>

                <button type="submit" id="submit-button" class="submit-button">Submit Server</button>
            </form>

            <div id="submission-status" class="submission-status"></div>
        </div>

        <input type="text" id="search-box" placeholder="🔍 Pesquise por uma tag...">

    </center>

    <table>
        <thead>
            <tr>
                <th>Server Tag</th>
                <th>Membros</th>
                <th>Convite</th>
            </tr>
        </thead>
        <tbody id="tabela-tags">
            </tbody>
    </table>

    <div id="blacklist">
        <div>
            <div>
                <h3>Add ID</h3>
                <input type="text" id="add-id" placeholder="Enter ID" />
                <button onclick="addToBlacklist()">Add</button>
            </div>

            <div>
                <h3>Current Blacklist</h3>
                <ul id="blacklist-list"></ul>
            </div>

            <div id="message"></div>
            <hr>
        </div>
    </div>

    <button onclick="login()">Admin login</button>

    <script>
        let password = null;
        let allTags = []; // Armazenar os dados da API aqui

        const form = document.getElementById('tag-submit-form');
        const tabela = document.getElementById("tabela-tags");
        const inviteInput = document.getElementById('server-invite');
        const submitButton = document.getElementById('submit-button');
        const submissionStatus = document.getElementById('submission-status');
        const searchBox = document.getElementById("search-box");

        // Função para exibir as tags (aceita um filtro)
        function displayTags(filter = "") {
            tabela.innerHTML = ''; // Limpa a tabela
            const quantasSaoNovas = 10;
            const filterLower = filter.toLowerCase();

            // 1. Filtra os dados com base no texto de pesquisa
            let filteredTags = allTags.filter(linha => linha.tag && linha.tag.toLowerCase().includes(filterLower));

            // 2. Itera sobre os dados filtrados e adiciona-os à tabela
            if (filteredTags.length === 0 && allTags.length > 0) {
                 tabela.innerHTML = '<tr><td colspan="3">Nenhuma tag encontrada com a pesquisa atual.</td></tr>';
                 return;
            } else if (allTags.length === 0) {
                 tabela.innerHTML = '<tr><td colspan="3">Nenhuma tag para exibir.</td></tr>';
                 return;
            }

            filteredTags.forEach((linha, index) => {
                // O marcador "new" aparece nas primeiras X tags (as mais recentes) se não houver filtro.
                const isNew = !filter && index < quantasSaoNovas;
                
                const tr = document.createElement("tr");
                const img = `<img class="icon" src="https://cdn.discordapp.com/clan-badges/${linha.serverID}/${linha.tagHash}.png?size=16">`
                
                tr.innerHTML = `
                    <td><div style="display: flex; align-items: center;">${img}${linha.tag}${isNew ? '<span class="new">NEW</span>' : ''}</div></td>
                    <td>${linha.members ? linha.members.toLocaleString('pt-PT') : 'N/A'}</td>
                    <td><a href="https://discord.gg/${linha.value}" target="_blank">🔗 Convite</a></td>
                `;
                tabela.appendChild(tr);
            });
        }

        // Função para carregar dados da API
        async function getInformation() {
            tabela.innerHTML = '<tr><td colspan="3">A carregar tags...</td></tr>'; // Mensagem de carregamento

            try {
                // Busca a blacklist primeiro
                const blacklistRes = await fetch('https://tags.mgcounts.com/api/api/blacklist');
                if (!blacklistRes.ok) throw new Error("Erro ao carregar a blacklist.");
                const blacklist = await blacklistRes.json();
                
                // Busca as tags
                const tagsRes = await fetch("https://tags.mgcounts.com/api");
                if (!tagsRes.ok) throw new Error("Erro ao carregar os dados das tags.");
                const data = await tagsRes.json();

                if (typeof data !== 'object' || data === null) {
                    throw new Error("Formato de dados da API inesperado.");
                }
                
                let tagArray = Object.values(data);
                
                // Inverte para colocar as tags mais recentes no topo (assumindo que o objeto JSON tem as mais recentes no final)
                tagArray.reverse();
                
                // Filtra as tags removendo as que estão na blacklist
                const filteredData = tagArray.filter(linha => linha.serverID && !blacklist.includes(linha.serverID)); 
                
                allTags = filteredData; // Armazena a lista global
                displayTags(); // Exibe todas as tags carregadas

            } catch (error) {
                console.error("Erro ao carregar dados da API:", error);
                tabela.innerHTML = `<tr><td colspan="3">Erro ao carregar as tags do servidor: ${error.message}.</td></tr>`;
                allTags = []; // Limpa a lista em caso de erro
            }
        }

        // Evento de pesquisa em tempo real
        searchBox.addEventListener("input", (e) => {
            displayTags(e.target.value);
        });

        // =========================================================================
        // Funções de Submissão e Admin (Mantidas)
        // =========================================================================
        function extractInviteCode(input) {
            input = input.trim();
            if (input.endsWith('/')) {
                input = input.slice(0, -1);
            }
            if (input.includes('discord.gg/')) {
                return input.split('discord.gg/')[1].split('?')[0].split('#')[0];
            }
            if (input.includes('discord.com/invite/')) {
                return input.split('discord.com/invite/')[1].split('?')[0].split('#')[0];
            }
            return input;
        }

        form.addEventListener('submit', function (e) {
            e.preventDefault();

            const inviteCode = extractInviteCode(inviteInput.value);

            submitButton.disabled = true;
            submitButton.textContent = 'Processing...';
            submissionStatus.textContent = 'Verifying invite...';
            submissionStatus.className = 'submission-status loading';

            setTimeout(function () {
                fetch('https://tags.mgcounts.com/api/submit-server', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ inviteCode: inviteCode })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            submissionStatus.textContent = data.message || 'Success! Server added to our verification queue.';
                            submissionStatus.className = 'submission-status success';
                            getInformation(); // Tenta recarregar a lista
                        } else {
                            submissionStatus.textContent = data.message || 'Error adding server. Please try again.';
                            submissionStatus.className = 'submission-status error';
                        }
                    })
                    .catch(error => {
                        submissionStatus.textContent = 'Network error. Please try again later.';
                        submissionStatus.className = 'submission-status error';
                        console.error('Error:', error);
                    })
                    .finally(() => {
                        submitButton.textContent = 'Submit Server';
                        submitButton.disabled = false;
                    });
            }, 1500);
        });


        async function loadBlacklist() {
            const res = await fetch('https://tags.mgcounts.com/api/api/blacklist');
            const list = await res.json();
            const ul = document.getElementById('blacklist-list');
            ul.innerHTML = '';
            list.forEach(id => {
                const li = document.createElement('li');
                li.textContent = id + ' ';
                const btn = document.createElement('button');
                btn.textContent = 'Remove';
                btn.onclick = () => removeFromBlacklist(id);
                li.appendChild(btn);
                ul.appendChild(li);
            });
        }

        async function addToBlacklist() {
            const id = document.getElementById('add-id').value.trim();
            if (id && password) {
                try {
                    const res = await fetch(`https://tags.mgcounts.com/${password}/api/api/blacklist/add/${id}`, { method: 'POST' });
                    const data = await res.json();
                    showMessage(data.message);
                    document.getElementById('add-id').value = '';
                    loadBlacklist();
                    getInformation(); // Recarrega as tags para aplicar a blacklist
                } catch {
                    showMessage('Incorrect password!');
                }
            }
        }

        async function removeFromBlacklist(id) {
            const res = await fetch(`https://tags.mgcounts.com/${password}/api/api/blacklist/remove/${id}`, { method: 'DELETE' });
            const data = await res.json();
            showMessage(data.message);
            loadBlacklist();
            getInformation(); // Recarrega as tags para aplicar a blacklist
        }

        function showMessage(msg) {
            const div = document.getElementById('message');
            div.textContent = msg;
            setTimeout(() => div.textContent = '', 3000);
        }

        function login() {
            let div = document.createElement('input');
            let button = document.createElement('button');
            div.placeholder = 'password';
            button.innerText = 'Submit'
            button.onclick = function () {
                if (div.value.length > 35) {
                    password = div.value;
                    document.getElementById('blacklist').style.display = 'flex';
                    loadBlacklist();
                } else {
                    alert('Incorrect password.');
                }
                div.remove();
                button.remove();
            }
            document.body.appendChild(div);
            document.body.appendChild(button);
        }
        
        // --- Inicialização ---
        getInformation();
    </script>

</body>

</html>
